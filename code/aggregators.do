_g2004_2003_2004 _g2004_2003_2005 _g2004_2003_2006 _g2004_2003_2007 _g2006_2005_2006 _g2006_2005_2007 _g2007_2006_2007
program drop csdid_ols
program csdid_ols
	syntax anything
	*display "`anything'"
	local my $ML_y
	gettoken wgt my:my
	gettoken lnf 1:0
	qui: {
		replace `lnf'=0
		while "`1'"!="" {
		    local cnt = `cnt'+1
			gettoken xx 1:1
			gettoken yy my:my
			*display in w "`lnf'-(`yy'-`xx')^2 if `yy' !=."
			replace `lnf'=`lnf'-`wgt'*(`yy'-`xx')^2 if `yy' !=. 
		}
	}
end

tab first_treat if , gen(f_)
replace f_2 =. if first==0
replace f_3 =. if first==0
replace f_4 =. if first==0

 _g2004_2003_2004 _g2004_2003_2005 _g2004_2003_2006 _g2004_2003_2007
 _g2006_2003_2004 _g2006_2004_2005 _g2006_2005_2006 _g2006_2005_2007 
 _g2007_2003_2004 _g2007_2004_2005 _g2007_2005_2006 _g2007_2006_2007
 
 matrix drop bs
foreach i in _g2004_2003_2004 _g2004_2003_2005 _g2004_2003_2006 _g2004_2003_2007 _g2006_2003_2004 _g2006_2004_2005 _g2006_2005_2006 _g2006_2005_2007 _g2007_2003_2004 _g2007_2004_2005 _g2007_2005_2006 _g2007_2006_2007 {
    sum `i'
	matrix bs=nullmat(bs),r(mean)
}

foreach i in    f_2 f_3 f_4 {
    sum `i'  
	matrix bs=nullmat(bs),r(mean)
}

ml model lf myols2 ( xb1:wgt _g2004_2003_2004=) (xb2: _g2004_2003_2005=) (xb3: _g2004_2003_2006=) (xb4: _g2004_2003_2007=) ///
				   (xb5: _g2006_2003_2004=) (xb6: _g2006_2004_2005=) (xb7: _g2006_2005_2006=) (xb8: _g2006_2005_2007=) ///
				   (xb9: _g2007_2003_2004=) (xb10:_g2007_2004_2005=) (xb11:_g2007_2005_2006=) (xb12:_g2007_2006_2007=) ///
				   (w1: f_2 =) (w2:f_3=) (w3:f_4=), maximize miss robust init(bs,copy) trace  
ml display
matrix b=e(b)
matrix V=e(V)

matrix coleq b = g2004 g2004 g2004 g2004 g2006 g2006 g2006 g2006 g2007 g2007 g2007 g2007 wgt wgt wgt
matrix coleq V = g2004 g2004 g2004 g2004 g2006 g2006 g2006 g2006 g2007 g2007 g2007 g2007 wgt wgt wgt
matrix roweq V = g2004 g2004 g2004 g2004 g2006 g2006 g2006 g2006 g2007 g2007 g2007 g2007 wgt wgt wgt

matrix colname b = t_2003_2004 t_2003_2005 t_2003_2006 t_2003_2007 ///
				 t_2003_2004 t_2004_2005 t_2005_2006 t_2005_2007 ///
				 t_2003_2004 t_2004_2005 t_2005_2006 t_2006_2007 w2004 w2006 w2007
matrix colname V = t_2003_2004 t_2003_2005 t_2003_2006 t_2003_2007 ///
				 t_2003_2004 t_2004_2005 t_2005_2006 t_2005_2007 ///
				 t_2003_2004 t_2004_2005 t_2005_2006 t_2006_2007 w2004 w2006 w2007
matrix rowname V = t_2003_2004 t_2003_2005 t_2003_2006 t_2003_2007 ///
				 t_2003_2004 t_2004_2005 t_2005_2006 t_2005_2007 ///
				 t_2003_2004 t_2004_2005 t_2005_2006 t_2006_2007 w2004 w2006 w2007				  
adde repost b=b V=V, rename				 

** Pretest. Seems equivalent to testing ALL Pre periods.
test ([g2006]t_2003_2004=0 ) ( [g2006]t_2004_2005=0) ( [g2007]t_2003_2004=0) ( [g2007]t_2004_2005=0) ( [g2007]t_2005_2006=0)

** Simple				   
nlcom (Simple: ((_b[g2004:t_2003_2004]+_b[g2004:t_2003_2005]+_b[g2004:t_2003_2006]+_b[g2004:t_2003_2007])*_b[wgt:w2004]+ 	   (_b[g2006:t_2005_2006]+_b[g2006:t_2005_2007])*_b[wgt:w2006]+_b[g2007:t_2006_2007]*_b[wgt:w2007])/(_b[wgt:w2004]*4+_b[wgt:w2006]*2+_b[wgt:w2007]) )

nlcom (E_3: ( _b[g2007:t_2003_2004]*_b[wgt:w2007]) /// 
			/(_b[wgt:w2007])) ///  
	(E_2: ( _b[g2006:t_2003_2004]*_b[wgt:w2006]+ ///
	         _b[g2007:t_2004_2005]*_b[wgt:w2007]) /// 
			/(_b[wgt:w2006]+_b[wgt:w2007])) /// 
			(E_1: ( _b[g2006:t_2004_2005]*_b[wgt:w2006]+ ///
	         _b[g2007:t_2005_2006]*_b[wgt:w2007]) /// 
			/(_b[wgt:w2006]+_b[wgt:w2007])) ///   
(E0: ( _b[g2004:t_2003_2004]*_b[wgt:w2004]+ ///
	         _b[g2006:t_2005_2006]*_b[wgt:w2006]+ ///
	         _b[g2007:t_2006_2007]*_b[wgt:w2007]) /// 
			/(_b[wgt:w2004]+_b[wgt:w2006]+_b[wgt:w2007]))	///   
	(E1: ((_b[g2004:t_2003_2005])*_b[wgt:w2004]+ ///
	   (_b[g2006:t_2005_2007])*_b[wgt:w2006])/(_b[wgt:w2004]+_b[wgt:w2006]))	///
	(E2: ((_b[g2004:t_2003_2006])*_b[wgt:w2004]) /(_b[wgt:w2004]))	   ///
	(E3: ((_b[g2004:t_2003_2007])*_b[wgt:w2004]) /(_b[wgt:w2004]))	 , post
** group
nlcom (g2004: (_b[g2004:t_2003_2004]+ _b[g2004:t_2003_2005] + _b[g2004:t_2003_2006] + _b[g2004:t_2003_2007])/4) ///
(g2006: (_b[g2006:t_2005_2006]+ _b[g2006:t_2005_2007] )/2) ///
(g2007: (_b[g2007:t_2006_2007]/1)) 
** Calendar Year
nlcom (t2004: _b[g2004:t_2003_2004]) (t2005: _b[g2004:t_2003_2005]) ///
	  (t2006: (_b[g2004:t_2003_2006] + _b[g2006:t_2005_2006])/2)	 ///
	  (t2007: (_b[g2004:t_2003_2007] + _b[g2006:t_2005_2007] + _b[g2007:t_2006_2007] )/3)	 
	  
nlcom 	(t2004: _b[g2004:t_2003_2004]) ///
		(t2005: _b[g2004:t_2003_2005]) ///
		(t2006: (_b[g2004:t_2003_2006]*_b[wgt:w2004] + _b[g2006:t_2005_2006]*_b[wgt:w2006])/(_b[wgt:w2004]+_b[wgt:w2006]))	 ///
		(t2007: (_b[g2004:t_2003_2007]*_b[wgt:w2004] + _b[g2006:t_2005_2007]*_b[wgt:w2006] + _b[g2007:t_2006_2007]*_b[wgt:w2007] )/(_b[wgt:w2004]+_b[wgt:w2006]+_b[wgt:w2007]))	 	  
